function asyncFetchVertexDataById(e,t,n){$.getJSON(t+"/"+e,n)}function asyncFetchDataMatchingFilters(e,t,n){$.getJSON(t+"/?filter="+JSON.stringify(e.serialize())).done(function(t){n({filterName:e.name,results:t})}).fail(function(t){n({filterName:e.name,results:null,status:t.status,error:t.statusText})})}function getColor(e,t){return"vertex"==t?colorPool(e):"#555"}function transformColor(e,t){var n="#";e=e.substr(1,e.length);for(var i=0;3>i;i++){var l=parseInt(e.substr(2*i,2),16);l=Math.round(Math.min(Math.max(0,l+l*t),255)),n+=l.toString(16)}return n}function dictToStr(e,t){void 0===t&&(t=",");var n="";for(var i in e)n&&(n+=t+" "),n+='<span class="info-properties-key">'+i+'</span>: <span class="info-properties-value">'+e[i]+"</span>";return n}function createTagHTML(e){return'<span class="label" style="background-color:'+e.color+';"><strong>'+e.label.toUpperCase()+"</strong></span> "}function deleteChildrenFromCollection(e,t,n){function i(n){r=t[d][n].id,r!==e&&-1===a.indexOf(r)&&null!==t[d][n].parentVertexId&&a.push(r)}for(var l=0,a=[e],r=null;a.length>0;){e=a.pop();for(var d=0;d<t.length;d++)t[d].parentVertexId===e&&("edge"===t[d].type&&["source","target"].forEach(i),"vertex"===t[d].type&&(r=t[d].id,r!==e&&-1===a.indexOf(r)&&a.push(r)),delete n[t[d].id],t.splice(d--,1),l++)}return l}function processData(e,t,n){void 0===t&&(t={vertices:{},edges:{}});var i=t.vertices.raw||{},l=t.edges.raw||{},a=[],r=[],d=t.labels||{vertex:[],edge:[],tags:{vertex:{},edge:{}}},o=[],s=[];e.vertices.forEach(function(e){if(void 0===i[e.id]){var t=e.properties.name||e.id;i[e.id]={type:"vertex",id:e.id,name:t,label:e.label,color:transformColor(getColor(e.label,"vertex"),.3),borderColor:getColor(e.label,"vertex"),imports:[],in_connections:parseInt(e.metadata.in_edge_count)||0,out_connections:parseInt(e.metadata.out_edge_count)||0,visiblyConnectedEdges:[],isVisible:!0,parentVertexId:n?n.id:null},void 0===d.tags.vertex[e.label]&&(d.tags.vertex[e.label]=createTagHTML(i[e.id])),i[e.id].info=d.tags.vertex[i[e.id].label]+e.id+" {"+dictToStr(e.properties)+"}",i[e.id].parentVertexId===e.id&&(i[e.id].parentVertexId=null),-1===d.vertex.indexOf(e.label)&&d.vertex.push(e.label),o.push(i[e.id])}}),e.edges.forEach(function(e){if(void 0===l[e.id]){var t=i[e.head_id],a=i[e.tail_id];l[e.id]={type:"edge",id:e.id,source:t,target:a,label:e.label,color:getColor(null,"edge"),properties:e.properties,isVisible:!0,parentVertexId:n?n.id:null},void 0===d.tags.edge[e.label]&&(d.tags.edge[e.label]=createTagHTML(l[e.id])),l[e.id].info="("+t.id+") "+d.tags.edge[l[e.id].label]+" â†’  ("+a.id+") {"+dictToStr(e.properties)+"}",s.push(l[e.id]),i[e.head_id].imports.push(e.tail_id),-1==d.edge.indexOf(e.label)&&d.edge.push(e.label)}});for(var c in i)a.push(i[c]);for(c in l)r.push(l[c]);return{vertices:{raw:i,diff:o,group:a},edges:{raw:l,diff:s,group:r},labels:d}}function attachHelpMenu(e,t){function n(e,t){var n=document.createElement("li");n.innerHTML="<strong>"+e+"</strong> "+t,l.appendChild(n)}var i=document.createElement("div"),l=document.createElement("ul");t.pin!==!1&&(n("Left Click","to pin and/or move a node around"),n("Right Click","to unpin a node")),t.openNewTab!==!1&&n("Middle Click","to open in another tab"),t.expand!==!1&&(n("Double Click","to expand a node"),n("Shift + Double Click","to collapse a node")),t.reCenter!==!1&&n("Ctrl + Double Click","to re-center to the node"),n("?","to toggle this help"),i.className="help",l.className="list-unstyled",i.appendChild(l),e.append($(i)),$(window).keypress(function(e){63===e.keyCode&&$(".help").toggleClass("deactivated")})}function attachControlPanel(e){function t(e,t,n,i,l){var a=document.createElement("li"),r=document.createElement("input"),d=document.createElement("label"),o=document.createElement("span");return r.type="radio",r.name="ruruki-cp-tabs",r.id="ruruki-cp-tab-"+e,r.checked=void 0!==l?l:!1,o.className=n,d.className="ruruki-cp-tabs label",d.htmlFor="ruruki-cp-tab-"+e,d.title=t,d.appendChild(o),a.className="ruruki-cp-tabs-container",a.appendChild(r),a.appendChild(d),a.appendChild(i),i.className="ruruki-cp-tab-content",i.id="ruruki-cp-tab-content-"+e,a}var n=document.createElement("div"),i=document.createElement("div"),l=document.createElement("div"),a=document.createElement("ul"),r=document.createElement("div"),d=document.createElement("div"),o=document.createElement("span"),s=document.createElement("div"),c=document.createElement("span"),u=document.createElement("div"),p=document.createElement("div"),f=document.createElement("div"),h=document.createElement("ul"),m=document.createElement("div"),g=document.createElement("ul"),v=document.createElement("div"),y=document.createElement("div"),b=document.createElement("ul");a.className="ruruki-cp-tabs",a.appendChild(t("pre","Pre Defined Filters","glyphicon glyphicon-tags",u,!0)),a.appendChild(t("custom","Custom Filters","glyphicon glyphicon-search",p)),n.className="ruruki-cp",i.className="ruruki-cp-title",l.className="container inspector",r.className="container inspector",d.className="row title",o.className="inspector-title",o.appendChild(document.createTextNode("Control Panel")),c.className="glyphicon glyphicon-resize-small",s.className="inspector-expander",s.appendChild(c),d.appendChild(o),d.appendChild(s),f.className="row property",h.className="list-unstyled",h.id="inspector-toggle-vertex",f.appendChild(h),m.className="row property",g.className="list-unstyled",g.id="inspector-toggle-edge",m.appendChild(g),u.appendChild(f),u.appendChild(m),v.id="custom-defined-filter-editor",y.className="row property",y.id="BLA",b.className="list-unstyled",b.id="inspector-custom-filters",y.appendChild(b),p.appendChild(v),p.appendChild(y),l.appendChild(a),r.appendChild(d),n.appendChild(l),i.appendChild(r),e.append($(n)),e.append($(i)),c.onclick=function(){"hidden"===n.style.visibility?(c.className="glyphicon glyphicon-resize-small",n.style.visibility="visible"):(c.className="glyphicon glyphicon-resize-full",n.style.visibility="hidden")}}function attachInfoPanel(e){var t=document.createElement("div"),n=document.createElement("div");t.className="ruruki-info info",t.appendChild(document.createTextNode("Loading info...")),n.className="ruruki-info detail",n.appendChild(document.createTextNode("Loading detail...")),e.append($(t)),e.append($(n))}function loadCSS(e){var t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,t.media="all",document.head.appendChild(t)}var MAX_RADIUS=40;if("d3"in window)var colorPool=d3.scale.category10();var CustomFilter=function(e,t){t||(t="blue"),this.id="cf"+Date.now(),this.name=e,this.filters=[],this.linkTypes=[],this.color=t,this.result=null};CustomFilter.prototype.clone=function(){var e=JSON.parse(JSON.stringify(this)),t=new CustomFilter;for(var n in e)t[n]=e[n];return t},CustomFilter.prototype.add=function(e,t){if(!e)throw"Invalid filter: "+e+"! Ignored!";if(t=(t||"AND").toUpperCase(),"AND"!==t&&"OR"!==t)throw"Invalid filter link type: "+t+"! Defaulting to AND";this.filters.push(e),this.filters.length>1&&this.linkTypes.push(t||"AND")},CustomFilter.prototype.remove=function(e){if(!e)throw"Invalid filter: "+e+"! Ignored!";var t=this.filters.indexOf(e);if(-1===t)throw"Filter not in sequence! Ignoring...";this.filters.splice(t,1),0===this.filters.length&&(this.linkTypes=[]),this.linkTypes.length>0&&(0===t?this.linkTypes.splice(0,1):this.linkTypes.splice(t-1,1)),this.result=null},CustomFilter.prototype.forEach=function(e,t){for(var n=0;n<this.filters.length;n++)e(this.filters[n],this.linkTypes[n-1])},CustomFilter.prototype.serialize=function(){var e=[];return this.forEach(function(t,n){e.push([t,n])}),e};var RurukiEye=function(e){function t(){B=D.width()||B,_=D.height()||_,$(".ruruki-main-responsive").css("width",B),$(".ruruki-main-responsive").css("height",_),z.attr("viewBox","0 0 "+B+" "+_)}function n(){Y=Y.data(H),J=J.data(R),U=U.data(H),z.append("defs").selectAll("marker").data(O.labels.edge).enter().append("marker").attr("class","arrowhead").attr("id",function(e){return e}).attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5"),Y.enter().append("text").attr("class",function(e){return"vertex text "+e.label}).attr("x",function(e){return f(e)+5}).attr("y",".31em").attr("id",function(e){return"vertex-text-"+e.id}).text(function(e){return e.name}),J.enter().append("path").attr("class",function(e){return"edge "+e.label}).attr("marker-end",function(e){return"url(#"+e.label+")"}).attr("id",function(e){return"edge-"+e.id}).on("mouseover",y).on("mouseout",C),U.enter().append("circle").attr("class",function(e){var t="vertex node "+e.label;return e.id==T&&(e.fixed=!0,e.clean=!0,t+=" fixed"),t}).attr("stroke",function(e){return e.id==T?M:e.borderColor}).style("fill",function(e){return e.id==T?M:e.color}).attr("r",function(e){return f(e)}).attr("id",function(e){return"vertex-"+e.id}).on("dblclick",N).on("click",v).on("mouseover",b).on("mouseout",C).on("contextmenu",g).call(X),u()}function i(e){var t=$(e.target).data();t.filterName&&L[t.filterName].result&&["vertices","edges"].forEach(function(e){var n="vertices"===e?"vertex":"edge";L[t.filterName].result[e].forEach(function(t){node=O[e].raw[t.id],node&&(z.selectAll("#"+n+"-"+node.id).classed("highlighted",!0),"vertex"===n&&z.selectAll("#"+n+"-text-"+node.id).classed("highlighted",!0))})})}function l(e){var t=$(e.target).data(),n="."+t.entityType+"."+t.entityLabel;z.selectAll(n).classed("highlighted",!0)}function a(){z.selectAll(".edge").classed("highlighted",!1),z.selectAll(".vertex").classed("highlighted",!1)}function r(e){return function(){o(L[e])}}function d(e){var t=L[e.filterName];if(t){var n=document.getElementById("custom-filter-"+t.id),i=document.getElementById("custom-filter-icon-"+t.id);void 0!==e.error&&(i.title="Invalid Filter! - "+e.error,i.style.display="inline",i.style.color="red"),t.result=e.results,t.result?$(n).removeClass("disabled"):$(n).addClass("disabled")}}function o(e,t){function n(e){f.disabled=!1,h.disabled=!1,m.disabled=!1}function i(t,i){if(i){var l=document.createElement("h1");l.className="ruruki-cp-divider",l.id="ruruki-cf-link-"+E,l.value=i,l.title="Click to change link type or right click to delete",l.appendChild(document.createTextNode(i)),l.onclick=function(e){var t=l.value;t="OR"===t?"AND":"OR",l.value=t,l.removeChild(l.childNodes[0]),l.appendChild(document.createTextNode(t)),f.disabled=!1,h.disabled=!1},l.oncontextmenu=function(n){n.preventDefault();try{e.remove(t)}catch(i){}o(e,!1)},a.appendChild(l)}var r=document.createElement("input");r.id="ruruki-cf-value-"+E++,r.type="text",r.placeholder="Filter",r.onkeyup=n,t&&(r.value=t),a.appendChild(r)}e=null===e?null:e.clone(),t=void 0===t?!0:t;var l=document.getElementById("custom-defined-filter-editor");$(l).empty();var a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),u=document.createElement("div"),p=document.createElement("button"),f=document.createElement("button"),h=document.createElement("button"),m=document.createElement("button"),g=document.createElement("span"),v=document.createElement("span"),y=document.createElement("span"),b=document.createElement("span"),C=document.createElement("input"),x=document.createElement("input"),E=0;return f.disabled=t,a.className="row property",r.className="row property",C.placeholder="Name",C.type="text",C.id="ruruki-cf-name",C.onkeyup=n,x.placeholder="Color",x.type="text",x.id="ruruki-cf-color",x.onkeyup=n,x.value="#00c",a.appendChild(C),a.appendChild(x),p.type="button",p.className="btn btn-xs btn-default",g.className="glyphicon glyphicon-plus",p.appendChild(g),p.title="Add Filter",p.onclick=function(){i("","AND")},f.type="button",f.className="btn btn-xs btn-success",v.className="glyphicon glyphicon-ok",f.appendChild(v),f.title="Save",f.onclick=function(){var t,n,i=new CustomFilter;i.name=document.getElementById("ruruki-cf-name").value,i.color=document.getElementById("ruruki-cf-color").value,i.add(document.getElementById("ruruki-cf-value-0").value);for(var l=1;E>l;l++)t=document.getElementById("ruruki-cf-value-"+l).value,n=document.getElementById("ruruki-cf-link-"+l).value,i.add(t,n);e&&delete L[e.name],L[i.name]=i,d({filterName:i.name,id:i.id,results:null},L),asyncFetchDataMatchingFilters(i,I,function(e){d(e,L)}),s(),o(null)},h.type="button",h.className="btn btn-xs btn-warning",y.className="glyphicon glyphicon-remove",h.appendChild(y),h.title="Cancel editing",h.onclick=function(){o(null)},m.type="button",m.className="btn btn-xs btn-danger",b.className="glyphicon glyphicon-trash",m.appendChild(b),m.title="Delete",m.onclick=function(){delete L[e.name],s(),o(null)},u.className="ruruki-cp-cf-controls left",u.appendChild(p),r.appendChild(u),c.className="ruruki-cp-cf-controls right",c.appendChild(f),r.appendChild(c),l.appendChild(a),l.appendChild(r),e&&e.filters&&0!==e.filters.length?(C.value=e.name,x.value=e.color,e.forEach(i),c.appendChild(h),c.appendChild(m)):i(),l}function s(){var e=$(document.getElementById("inspector-custom-filters"));e.empty();for(var t in L){var n=L[t],l=n.name,d=document.createElement("li"),o=$(d),s=document.createElement("label"),c=document.createElement("span"),u=document.createElement("strong"),p=document.createElement("span");n.forEach(function(e,t){t&&(l+=" "+t),l+=" "+e}),p.className="glyphicon glyphicon-warning-sign",p.style.display="none",p.id="custom-filter-icon-"+n.id,u.appendChild(document.createTextNode(t+"  ")),u.appendChild(p),u.dataset.filterName=t,c.className="label",c.style.backgroundColor=n.color,c.dataset.filterName=t,c.appendChild(u),s.className="inspector property",s.dataset.filterName=t,s.id="custom-filter-"+n.id,s.appendChild(c),n.result||(s.className+=" disabled"),d.dataset.filterName=t,d.title=l,d.appendChild(s),o.hover(i,a),o.click(r(n.name)),e.append(o),console.log("key",t,"filter",n)}}function c(){["edge","vertex"].forEach(function(e){var t=$("#inspector-toggle-"+e).empty();O.labels[e].forEach(function(n){var i=$("<li>"),r=$('<label class="inspector property">'+O.labels.tags[e][n]+"</label>");r.data({entityType:e,entityLabel:n}),r.children().data({entityType:e,entityLabel:n}),r.hover(l,a),i.append(r),t.append(i),V.status[e][n]===!1&&r.addClass("disabled"),r.on("click",function(){r.toggleClass("disabled"),V.status[e][n]=!r.hasClass("disabled"),x(e,n,V)})})})}function u(){q.html("Showing <i>"+R.length+"</i> edges linked to <i>"+H.length+"</i> vertices")}function p(){S?(U.attr("cx",function(e){return e.id===T&&e.clean===!0?e.x=e.px=B/2:e.x=Math.max(f(e),Math.min(B-f(e),e.x))}),U.attr("cy",function(e){return e.id===T&&e.clean===!0?e.y=e.py=_/2:e.y=Math.max(f(e),Math.min(_-f(e),e.y))})):U.attr("transform",h),Y.attr("transform",h),J.attr("d",function(e){return diffX=e.target.x-e.source.x,diffY=e.target.y-e.source.y,pathLength=Math.sqrt(Math.pow(diffX,2)+Math.pow(diffY,2)),offsetX=diffX*f(e.target)/pathLength,offsetY=diffY*f(e.target)/pathLength,"M"+e.source.x+","+e.source.y+"L"+(e.target.x-offsetX)+","+(e.target.y-offsetY)})}function f(e){return Math.min(5+.4*Math.max(e.in_connections,e.out_connections),MAX_RADIUS)}function h(e){return e.id==T&&e.clean===!0&&(e.x=B/2,e.y=_/2),"translate("+e.x+","+e.y+")"}function m(t){e.pin!==!1&&(t.id===T&&t.clean===!0&&delete t.clean,t&&d3.select(this).classed("fixed",t.fixed=!0))}function g(t){d3.event.preventDefault(),e.pin!==!1&&(t.id===T&&t.clean===!0&&delete t.clean,t&&d3.select(this).classed("fixed",t.fixed=!1))}function v(t){e.openNewTab!==!1&&t&&1===d3.event.button&&(win=window.open("/vertices/"+t.id,"_blank"))}function y(e){e.isVisible===!0&&(z.selectAll(".edge").classed("highlighted",function(t){return t===e}),z.selectAll(".vertex").classed("highlighted",function(t){return t===e.source||t===e.target}),K.html(e.info))}function b(e){e.isVisible===!0&&(z.selectAll(".edge").classed("highlighted",function(t){return t.source===e||t.target===e}),d3.select(this).classed("highlighted",!0),d3.select("#vertex-text-"+e.id).classed("highlighted",!0),K.html(e.info))}function C(){z.selectAll(".highlighted").classed("highlighted",!1),K.text("")}function x(){H.forEach(function(e){void 0===V.status[e.type][e.label]&&(V.status[e.type][e.label]=!0),e.isVisible=V.status[e.type][e.label],e.id==T&&(e.isVisible=!0)}),R.forEach(function(e){void 0===V.status[e.type][e.label]&&(V.status[e.type][e.label]=!0),e.isVisible=V.status[e.type][e.label],(e.source.isVisible===!1||e.target.isVisible===!1)&&(e.isVisible=!1),e.isVisible===!1?(-1!==e.source.visiblyConnectedEdges.indexOf(e.id)&&e.source.visiblyConnectedEdges.splice(e.source.visiblyConnectedEdges.indexOf(e.id),1),-1!==e.target.visiblyConnectedEdges.indexOf(e.id)&&e.target.visiblyConnectedEdges.splice(e.target.visiblyConnectedEdges.indexOf(e.id),1)):(-1===e.source.visiblyConnectedEdges.indexOf(e.id)&&e.source.visiblyConnectedEdges.push(e.id),-1===e.target.visiblyConnectedEdges.indexOf(e.id)&&e.target.visiblyConnectedEdges.push(e.id)),(0===e.source.visiblyConnectedEdges.length||0===e.target.visiblyConnectedEdges.length)&&(e.isVisible=!1),e.source.id==T&&(e.source.isVisible=!0),e.target.id==T&&(e.target.isVisible=!0)}),d3.selectAll(".vertex").attr("opacity",function(e){return e.id===T?1:0===e.visiblyConnectedEdges.length||e.isVisible===!1?0:1}),d3.selectAll(".edge").attr("opacity",function(e){return e.isVisible===!0?1:0})}function E(t){return e.expand!==!1?(q.html("Loading data for node <i> "+t.id+"</i>..."),void 0!==F?void F(t):void asyncFetchVertexDataById(t.id,w,function(e){O=processData(e,O,t),console.log(O.vertices.diff.length,"vertices added",O.edges.diff.length,"edges added"),O.vertices.diff.forEach(function(e){H.push(e)}),O.edges.diff.forEach(function(e){R.push(e)}),n(),x(),c(),P.start()})):void 0}function k(t){if(e.expand!==!1){var n=0,i=0;t.id===T?R.forEach(function(e){e.source.parentVertexId===t.id&&(n+=deleteChildrenFromCollection(e.source.id,H,O.vertices.raw),i+=deleteChildrenFromCollection(e.source.id,R,O.edges.raw)),e.target.parentVertexId===t.id&&(n+=deleteChildrenFromCollection(e.target.id,H,O.vertices.raw),i+=deleteChildrenFromCollection(e.target.id,R,O.edges.raw))}):(n+=deleteChildrenFromCollection(t.id,H,O.vertices.raw),i+=deleteChildrenFromCollection(t.id,R,O.edges.raw)),console.log(n,"vertices deleted",i,"edges deleted"),Y=Y.data(H),J=J.data(R),U=U.data(H),Y.exit().remove(),J.exit().remove(),U.exit().remove(),u(),P.start(),c()}}function N(t){if(d3.event.preventDefault(),d3.event.shiftKey)k(t);else if(d3.event.ctrlKey){if(e.reCenter===!1)return;window.location.href="/vertices/"+t.id}else E(t)}if(void 0===e.data||void 0===e.centerId)throw'Mandatory fields missing in configuration: "data", "centerId"';var w=e.expandEndpoint||"/vertices",I=e.filterEndpoint||"",F=e.expandCallback,T=e.centerId,A=e.container||"#ruruki-eye",D=$(A),M=e.centerNodeColor||"#FFDF00",V={status:{vertex:{},edge:{}}};loadCSS(e.cssUrl||"/static/css/ruruki-eye.css");var O=processData(e.data,void 0,{id:T}),L={},S=!0,B=D.width(),_=D.height(),P=d3.layout.force().nodes(d3.values(O.vertices.raw)).links(d3.values(O.edges.raw)).size([B,_]).linkDistance(function(e){return 60+4*Math.max(f(e.target),f(e.source))}).charge(-300).gravity(0).on("tick",p).start(),X=P.drag().on("dragstart",m),z=d3.select(A).append("div").classed("ruruki-main",!0).append("svg").attr("viewBox","0 0 "+B+" "+_).classed("ruruki-main-responsive",!0);e.help!==!1&&attachHelpMenu(D,e),e.controlPanel!==!1&&attachControlPanel(D),e.controlPanel!==!1&&o(null),e.infoPanel!==!1&&attachInfoPanel(D),s();var H=P.nodes(),R=P.links(),Y=z.append("g").selectAll("text"),J=z.append("g").selectAll("path"),U=z.append("g").selectAll("circle"),q=$(".ruruki-info.info"),K=$(".ruruki-info.detail").text("");t(),n(),c(),window.onresize=t,$(window).load(t())};