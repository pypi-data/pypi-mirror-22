#!/usr/bin/env python

# Python stuff
import os
import sys

# External libraries
import requests
from bs4 import BeautifulSoup


def getMagnetLink(search_query):
    search_URL = 'https://thepiratebay.org/search/'
    final_search_query = search_URL + search_query
    src = ""

    print 'Connecting to Server...'

    while len(src) <= 600:
        page = requests.get(final_search_query)
        src = page.text
    
    print 'Connected!'

    ob = BeautifulSoup(src, 'lxml')

    hyperlinks = ob.findAll('a')
    for link in hyperlinks:
        try:
            if link['href'].startswith('magnet'):
                return link['href']
                break
        except:
            pass


def main():
    if os.system('npm --version') != 0:
        print 'Install NPM to use showtime'
        exit()

    if os.system('peerflix --version') != 0:
        print 'Installing Peerflix...'
        os.system('npm install -g peerflix')

    search_query = '+'.join(sys.argv[1:])
    magnet_link_for_video = getMagnetLink(search_query)

    print 'Starting video stream...'

    os.system('peerflix "' + magnet_link_for_video + '" --vlc')


if __name__ == '__main__':
    main()
